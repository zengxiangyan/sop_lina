import datetime

from django.shortcuts import render

from sop.models import report_task
from sop import connect_clickhouse
from django.http import HttpResponseRedirect
from django.db.models import Max
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from . import batch174,lv_name
from django.http import FileResponse
from django.conf import settings
import os
from django.core.paginator import Paginator
from django.core import serializers
from  .serializers import report_taskSerializer
# from django.urls import reverse
import json
import mimetypes
from urllib.parse import quote
import pandas as pd
# Create your views here.
import json
import importlib

def dynamic_import(batch_id):
    module_name = f"batch{batch_id}"
    try:
        # 尝试动态导入模块
        module = importlib.import_module(f"..{module_name}", package=__name__)
        return module
    except ImportError as e:
        # 处理导入错误
        print(f"Error importing module: {e}")
        return None


def search(request):
    if request.method == 'GET':
        batchid = request.GET.get('batchid')
        ReportName = request.GET.get('ReportName')
        UpdateTime = request.GET.get('UpdateTime')
        PersonInCharge = request.GET.get('PersonInCharge')
        # 构建包含非空字段的筛选条件字典
        filter_kwargs = {}
        if batchid:
            filter_kwargs['BatchId'] = batchid
        if ReportName:
            filter_kwargs['ReportName'] = ReportName  # 确保字段名与模型中的一致
        if UpdateTime:
            filter_kwargs['UpdateTime__date'] = UpdateTime  # 确保字段名与模型中的一致
        if PersonInCharge:
            filter_kwargs['PersonInCharge'] = PersonInCharge  # 确保字段名与模型中的一致

        # 使用筛选条件查询数据库
        if filter_kwargs:
            queryset = report_task.objects.filter(**filter_kwargs)
        else:
            queryset = report_task.objects.all()
        # 分页处理
        try:
            page = int(request.GET.get('page', 1))  # 默认为第一页
            limit = int(request.GET.get('limit', 15))  # 默认页面大小为10
        except ValueError:
            page = 1
            limit = 15

        paginator = Paginator(queryset, limit)  # 创建分页对象
        try:
            page_obj = paginator.page(page)  # 获取特定页的记录
        except EmptyPage:
            page_obj = paginator.page(paginator.num_pages)  # 如果超出范围，显示最后一页

        serialized_qs = report_taskSerializer(page_obj, many=True)

        js = {
          "code": 0,
          "msg": "",
          "count": len(queryset),
          "data": serialized_qs.data
        }
        return JsonResponse(js)

# views.py

def download_file(request):
    path = request.GET.get('path')
    file_path = os.path.join(settings.MEDIA_ROOT, path)  # 构建文件的绝对路径
    print(file_path)
    if os.path.exists(file_path):
        response = FileResponse(open(file_path, 'rb'))  # 打开文件进行读取
        mime_type, _ = mimetypes.guess_type(file_path)
        response['Content-Type'] = mime_type or 'application/octet-stream'
        filename = os.path.basename(file_path)
        response['Content-Disposition'] = 'attachment; filename="{}"'.format(quote(filename))# 设置为附件形式并指定默认文件名
        return response
    else:
        # 如果文件不存在，你可以返回404或其他消息
        return render(request, 'sop/404.html',locals())


def add(request):
    if request.method == 'GET':
        batchid = request.GET.get('batchid')
        start_date = request.GET.get('start_date')
        end_date = request.GET.get('end_date')
        return render(request, 'report/add.html', locals())
    if request.method == 'POST':
        batchid = request.POST.get('batchid')
        start_date = request.POST.get('start_date')
        end_date = request.POST.get('end_date')

        try:
            # 使用 batch_id 动态导入模块
            module = dynamic_import(batchid)
            if module:
                # 如果模块导入成功，可以使用该模块
                Status,fileUrl = module.run(start_date,end_date)
                UpdateTime = datetime.datetime.now()
                pvPanelInfo = report_task.objects.filter(BatchId=batchid).order_by('-UpdateTime').values("UseModel","ReportName","PersonInCharge").first()
                UseModel, ReportName, PersonInCharge = pvPanelInfo['UseModel'],pvPanelInfo['ReportName'],pvPanelInfo['PersonInCharge']
                report_task.objects.create(BatchId=batchid, UseModel=UseModel, ReportName=ReportName,DateRange=start_date + '~' + end_date
                                           ,Status=Status,UpdateTime=UpdateTime,PersonInCharge=PersonInCharge,fileUrl='../media/?path=batch'+batchid+'/'+fileUrl)
                print("okk")
            #         pass
                return JsonResponse({'code': 200, "msg":"正在制作报告"})
        except:
            return render(request, 'sop/404.html',locals())

def save(request):
    if request.method == 'POST':
        # print("eid",request.GET.get('sql'))
        if (request.GET.get('eid')!=None) and (request.GET.get('tb')!=None) and (request.GET.get('sql')!=None):
            eid = request.GET.get('eid')
            tb = request.GET.get('tb')
            sql_list = """{}""".format(request.GET.get('sql'))
            sql = r"""{}""".format(sql_list)
            sql = sql.replace(r'@\n@','\n ')
            print(sql)
            try:
                session = connect_clickhouse.connect(0)
                cursor = session.execute(sql)
                fields = cursor._metadata.keys
                data = pd.DataFrame([dict(zip(fields, item)) for item in cursor.fetchall()])
                data_json = data.to_json(orient='records')
                print(data_json)
                return JsonResponse({'code': 200, "message": "success"})
            except:
                return JsonResponse({'code': 500, "message": "fail"})
        else:
            return JsonResponse({'code': 443,"error":"start_date与end_date不能为空"})
    else:
        return render(request, 'report/table.html', locals())
        # return JsonResponse({'code': 403,"error":"当前服务器拒绝GET方式请求，请使用POST方式"})

def upload(request):
    if request.method == 'GET':
        id = request.GET.get('id')
        return render(request, 'report/upload.html', locals())

    if request.method == 'POST':
        files = request.FILES.getlist('files[]')  # 获取文件列表
        file_urls = []
        for file in files:
            # 保存文件到服务器的操作
            file_name = default_storage.save(file.name, ContentFile(file.read()))
            file_url = default_storage.url(file_name)
            file_urls.append(file_url)
            print(file_urls)

        return JsonResponse({'message': 'Files uploaded successfully', 'fileUrls': file_urls}, status=200)

    return JsonResponse({'message': 'Invalid request'}, status=400)
@csrf_exempt
def get_uuid(request):
    if request.method == 'POST':
        if (request.META.get('HTTP_NAME') == "nint") and (request.META.get('HTTP_PASSWORD') == "chen.weihong"):
            if (request.POST.get('start_date')!=None) and (request.POST.get('end_date')!=None):
                start_date = request.POST.get('start_date')
                end_date = request.POST.get('end_date')
                try:
                    uuid2 = batch174.get_uuid2(start_date,end_date)
                    print(start_date,end_date,len(uuid2))
                    # uuid2 = [7281495057525354132, 7280382691046114123, 7277789449924622605, 7274442905903416085, 7276603459127123335, 7276603459127145365, 7276603459127156746, 7279220335453275046, 7276603459127131278, 7279220335453228649, 7274442905896164825, 7280382691067112223, 7278477619643306026, 7278850461459525839, 7280382691046134524, 7278104404167441015, 7279610520347198401, 7275199369902676921, 7276231691052489468, 7276603459127124177, 7276231691052523613, 7282595681543344555, 7281866838465753263, 7280382691042582672, 7278477619643359642, 7277789449924895327, 7281866838465720359, 7275199369902671848, 7279220335453240259, 7281136505044151674, 7275514732172118865, 7281495057511973001, 7281495057511970295, 7274442905903305992, 7276603459126829748, 7281136505079598003, 7281866838465435141, 7276993880242001352, 7281866838465419432, 7278850461471356451, 7279968862353837807, 7275199369902328773, 7275514732165954402, 7278104404167110129, 7281136505062836573, 7281866838465454013, 7280382691037583985, 7278477619643005428, 7278477619642979544, 7275514732172119319, 7274442905915235106, 7275514732156567426, 7275858342431099385, 7274442905896013127, 7281495057511968491, 7280382691037581827, 7278850461459254626, 7275858342431055023, 7281495057511967217, 7281136505044021341, 7276603459126810345, 7280382691057365372, 7281866838465398021, 7281866838465419431, 7275858342431035184, 7281136505052153225, 7279220335452896759, 7275514732156536508, 7280382691057358064, 7279968862353828085, 7275199369902261022, 7281136505068620943, 7277417892296525825, 7281136505059253238, 7279610520366174966, 7280382691045985959, 7281866838477798281, 7278850461459221993, 7281866838465411735, 7277789449924583612, 7278850461478801710, 7276993880241961407, 7277789449941129666, 7278850461471321916, 7279968862353811933, 7279968862366247309, 7276603459126805265, 7282968398788589342, 7281136505073964065, 7276993880241961412, 7276603459127299489, 7281866838477997909, 7278477619656362725, 7276993880242388127, 7276603459127295001, 7276603459127285596, 7280382691046191817, 7276603459127305655, 7279968862354484117, 7279968862354486582, 7279220335466375799, 7277789449924999040, 7280382691037743488, 7278477619643474847, 7275199369927291365, 7277417892296956962, 7282240195677379354, 7275514732166135549, 7275199369902878703, 7281495057512579174, 7279220335453449391, 7278477619642970241, 7278850461459728919, 7279220335471976624, 7274442905903471671, 7281495057512579180, 7280382691037747009, 7281866838465903920, 7277417892296975835, 7277789449914297771, 7278850461479134372, 7281495057511871404, 7275199369926743299, 7275199369902247297, 7282968398788583246, 7277789449914114861, 7282968398788583113, 7279220335452879924, 7281495057511871544, 7277789449914115502, 7275514732172121473, 7279968862353800373, 7274442905896001040, 7276231691052150723, 7280382691064068685, 7280382691037564252, 7281136505044003630, 7275858342431238768, 7275514732165988856, 7275199369926965216, 7276603459126988045, 7277789449924735431, 7277789449941144344, 7278104404167274894, 7276603459126797503, 7281136505068670852, 7279968862354070681, 7276231691052352193, 7275199369902492407, 7281495057512152657, 7281136505093137224, 7276603459126981499, 7281136505052274052, 7281136505044092297, 7281866838465519459, 7274442905909339404, 7278477619643130937, 7276603459126980110, 7279610520358924776, 7274442905903356285, 7282595681531844417, 7275199369902495744, 7276603459138321150, 7274442905903427270, 7281136505085942457, 7281495057525355528, 7276993880257141041, 7275199369926876570, 7277789449924664123, 7277789449914148358, 7281136505059312117, 7281136505052229872, 7282968398802246403, 7276603459126902732, 7279220335452991091, 7282968398802246425, 7279968862353959028, 7281495057512590766, 7276231691052263258, 7275199369902384732, 7276993880242043655, 7274442905896038223, 7281866838477853786, 7279220335471371391, 7274442905903334072, 7281136505089729398, 7281136505068649229, 7279968862372678313, 7276993880252085073, 7281495057512049647, 7281136505073997132, 7281495057512069411, 7277789449941133093, 7277789449937770851, 7277417892296602622, 7275858342431146270, 7281136505044056833, 7281866838465394444, 7276603459127309869, 7281136505079605775, 7276603459126858012, 7282240195677072590, 7281495057511986588, 7274442905907451589, 7275199369902343089, 7274442905912751839, 7279968862353926453, 7281495057511989234, 7276603459126791377, 7278477619656259351, 7277417892316146599, 7282968398802209693, 7275199369926840519, 7279610520346831106, 7282240195702612803, 7281866838465467686, 7281866838477830036, 7276603459126861467, 7276231691046793018, 7279610520358901317, 7280382691057395872, 7279968862371155751, 7281136505089728838, 7281495057512004651, 7276993880242017787, 7279610520366149646, 7282968398802744437, 7281866838465864971, 7278850461459698549, 7276603459127251444, 7275199369927268517, 7282240195702681603, 7276231691052642947, 7276603459127274399, 7274442905896196221, 7278104404167544290, 7274442905896196622, 7282595681532099042, 7275199369927259075, 7278477619656349094, 7281495057512522509, 7281866838477986994, 7282968398802679366, 7276603459127253355, 7276993880242364104, 7276993880242367570, 7281136505086012720, 7279610520371000682, 7278477619656350263, 7282968398825608377, 7280382691064067960, 7277789449945583884, 7279220335466359735, 7275858342431529185, 7274442905903455381, 7279968862369612058, 7276231691052639698, 7281866838465572089, 7281866838465565185, 7280382691051319450, 7276603459126969670, 7278850461459371756, 7282968398802340004, 7277789449924728487, 7275199369902482427, 7276603459126794817, 7277789449924727211, 7278850461478166596, 7275199369902401374, 7274442905896046470, 7278477619662301342, 7278850461459319026, 7282968398825567764, 7282595681531759513, 7282240195677142893, 7275858342431158556, 7282240195702616738, 7281866838465566448, 7282968398788618528, 7278104404167201779, 7275199369926966737, 7279220335466266450, 7282968398825599730, 7277417892296614457, 7281495057512138062, 7276993880242409243, 7281136505089746402, 7276231691052382617, 7281866838465595580, 7276603459126993571, 7276603459127017457, 7279968862354101142, 7281866838465596847, 7281495057512197401, 7279610520347008689, 7280382691046057003, 7281866838465598217, 7281495057512174646, 7281136505079673197, 7278850461459397041, 7277789449933435509, 7274442905896083842, 7275199369926987239, 7281136505044103627, 7280382691042575151, 7277417892310854445, 7275199369902538413, 7278477619656289961, 7280382691057467370, 7279220335466296621, 7282240195677171682, 7279220335466296596, 7282968398788657983, 7280382691057469591, 7280382691057466438, 7281495057512201850, 7275199369902515061, 7276231691052618876, 7276603459127242785, 7276231691052404056, 7279220335453399219, 7282595681531880102, 7278104404169945890, 7281866838465632990, 7276603459127023983, 7281136505074058243, 7276603459127020824, 7276603459127241077, 7276603459127023447, 7277417892296730153, 7278477619645568739, 7281136505068688075, 7282968398825608451, 7280382691037737439, 7279968862354131634, 7281136505074055863, 7281136505075151304, 7278850461459438569, 7279610520366185589, 7276603459127035277, 7279968862354147181, 7280382691042575894, 7278477619643191223, 7276603459139000977, 7278850461471403161, 7278477619643191217, 7275199369902828632, 7276603459126883391, 7279968862353943775, 7280382691046013454, 7276603459126879962, 7276603459138318244, 7281495057512034166, 7275199369926864622, 7282240195677092126, 7280382691046010468, 7275514732176430810, 7281495057512025634, 7276603459126885756, 7276993880242033416, 7279220335452987153, 7282240195702615278, 7275199369902370612, 7278104404167181401, 7279220335452979821, 7276603459126885402, 7276231691052257337, 7281136505044047744, 7282240195677084452, 7281866838465481685, 7275199369902372311, 7281136505052225502, 7275199369926866413, 7275199369902373550, 7280382691057418163, 7274442905903333677, 7282240195688102576, 7281136505074064689, 7276603459127067978, 7280382691046096069, 7281136505074072654, 7281136505079636712, 7277417892296741797, 7278850461459517959, 7281866838477898063, 7276603459127066857, 7280382691057479698, 7277789449937826952, 7275199369902586542, 7280382691057485012, 7276603459127093321, 7275858342431334077, 7278104404167216842, 7275858342431374114, 7282968398825587045, 7281495057512097155, 7282968398825587385, 7280382691046097513, 7279968862366306761, 7276993880257144660, 7279968862354184310, 7282240195702638773, 7276993880257144127, 7277789449937817493, 7275199369902633397, 7279968862354195792, 7276993880255483246, 7275858342443581344, 7282595681531803543, 7276603459126935128, 7276603459126917236, 7274442905896124440, 7281136505059401570, 7278477619646889868, 7275199369926897377, 7276603459126931437, 7277789449924687920, 7277789449943118284, 7276603459126928257, 7281866838484075245, 7275514732165990387, 7282240195702620579, 7281136505085947060, 7279968862354022110, 7280382691046036996, 7281866838477869905, 7281495057512092400, 7278104404167224221, 7279968862373750774, 7275199369926917867, 7279968862354026563, 7275199369902438569, 7281495057512097113, 7279220335453016553, 7275858342431349127, 7281495057512078479, 7280382691051332929, 7277789449924632944, 7274442905896027060, 7276603459127306433, 7275199369902885826, 7276603459126856681, 7279968862354486221, 7276603459127307944, 7275514732165982815, 7276603459127043671, 7277789449937799705, 7275858342431048216, 7274442905909370705, 7281136505089748102, 7278850461471390087, 7281136505079634013, 7275199369939589479, 7282240195697113535, 7279220335453036916, 7279610520347376605, 7281136505068771133, 7278477619643097627, 7281495057512101462, 7280382691051534074, 7279968862354519282, 7281866838465907606, 7282968398817098497, 7276603459127310586, 7276603459138323160, 7275514732166136297, 7275199369902421026, 7275199369902161101, 7279968862353751398, 7276603459126745382, 7275199369902154656, 7275858342431017720, 7281495057511805278, 7275199369926740990, 7274442905915233592, 7278477619642889941, 7275199369926718437, 7280382691057355456, 7276231691052067836, 7281136505043967229, 7275858342430952581, 7279220335452838015, 7277417892296464526, 7280382691037541941, 7278850461459161371, 7275972790413470483, 7278068274894362826, 7275972790413470548, 7282910390977738447, 7277582707364736751, 7281787965693143996, 7282910390964322749, 7278808924825353279, 7277817762345770085, 7276210070179242006, 7278068274894362580, 7275972790413429150, 7276210070179241797, 7281866353126946138, 7278068274894362864, 7277817762345770004, 7274076137150486259, 7276300075511354742, 7282985299481729276, 7281400873173146597, 7274442089838940883, 7274442089838940825, 7276300075511354808, 7278068274894362571, 7275581089396036620, 7282237451186232890, 7277817762345709486, 7280786619823594730, 7276300075511354858, 7277042241565172997, 7278895382515178207, 7279185241269915502, 7275972790413470319, 7275972790413470291, 7281787965681373443, 7276210070179239216, 7281787965681374097, 7280731395142922519, 7275972790413429122, 7276210070179239945, 7276210070179239547, 7278438518255221210, 7276210070179239457, 7278808924825350272, 7283268402262054710, 7282237451186232768, 7282237451186232649, 7278895382515178258, 7281539080913951028, 7276584518312640069, 7274442089838940753, 7282608519180731532, 7281866353126946005, 7282985299481728889, 7276300075511354558, 7277449417349686107, 7276300075511354576, 7282237451186211402, 7282237451186232641, 7278808924825351673, 7275972790413470185, 7282237451186232507, 7275972790413470057, 7281400873169972447, 7276210070179237761, 7274813162128416657, 7276210070179237484, 7276210070179239551, 7276584518312636126, 7282608519180731247, 7277329574879405094, 7274750472788589366, 7275099640745051373, 7274076137150485840, 7280731395136072826, 7276210070179238078, 7278895382515178029, 7276300075511354511, 7276300075511354499, 7279548226142228659, 7276300075511354231, 7274076137150485734, 7277042241565138433, 7276210070183317288, 7282985299481728545, 7275972790413429085, 7277817762345769855, 7274442089838940384, 7278068274901563695, 7282989031808315066, 7276210070179235911, 7275972790413469981, 7279548226145244435, 7276210070179235924, 7282910390959289528, 7276210070179236209, 7275972790413469963, 7276210070179235919, 7276210070179236384, 7281400873168426950, 7281400873169972105, 7276210070179236402, 7274909317856240952, 7277582707364736693, 7274359471856419213, 7276300075511354107, 7278168390580055303, 7278895382515177747, 7275972790413470005, 7276671156390754319, 7277449417349685695, 7278808924831717714, 7280379448333969381, 7277817762345795348, 7276584518312635755, 7276584518312635998, 7276300075511354110, 7275581089396035954, 7282184958106381799, 7281866353126945624, 7275972790413498129, 7276584518314021170, 7279185241282556298, 7282910390960449524, 7276300075511384934, 7276210070180650775, 7275972790413498121, 7278808924832004689, 7274359471856796082, 7276300075511384841, 7276300075511384842, 7280295627756070752, 7276584518316405195, 7280731395143999431, 7276584518317136257, 7274076137150492518, 7281517236713270637, 7281517236716016237, 7280731395160040502, 7282184958113717835, 7276210070179243830, 7277329574879412164, 7275972790413470809, 7275972790413470748, 7276210070185127549, 7276210070179249608, 7279185241269920729, 7283268402264707343, 7276210070179244104, 7276210070179244065, 7274359471856422361, 7277329574879411453, 7280295627764870435, 7276210070179244274, 7275836670017590688, 7283268402266021131, 7281400873168428547, 7277042241565139000, 7275581089396038911, 7281400873172235425, 7276300075511355095, 7280786619823559134, 7281038983520792778, 7279637256510378540, 7276300075511355105, 7278438518255227059, 7276955633556762924, 7277042241565138941, 7281866353126946647, 7282237451186233183, 7276210070179243083, 7276210070179243355, 7275972790413429185, 7280295627754731015, 7276210070179243308, 7278808924825356202, 7279548226142230241, 7278808924825356645, 7274359471859895701, 7276210070179243115, 7276210070179243134, 7278438518255225638, 7276210070179243112, 7274076137150486527, 7278438518255225502, 7281400873169973252, 7275972790413470640, 7277329574879411368, 7276300075511354957, 7276300075511354989, 7274359471856421817, 7275972790413470635, 7274750472788595018, 7278068274894364432, 7276955633552272869, 7281400873163421728, 7278438518255225739, 7280731395151172911, 7276300075511355028, 7274813162128415742, 7275972790413455526, 7278438518255215398, 7281400873168673077, 7274750472801172289, 7277582707364736562, 7276210070180650998, 7275972790413498155, 7276210070180651024, 7282910390960450130, 7275972790413498148, 7276210070180650950, 7281400873168672971, 7281400873170211555, 7281400873171485677, 7277329574880663572, 7274813162128447097, 7274076137150514930, 7280008354569700129, 7278895382515007661, 7281787965694018326, 7274909317856240848, 7282910390960450187, 7279548226135908246, 7275972790413469714, 7276300075511353720, 7276300075511353575, 7274076137150484816, 7278168390580044471, 7274813162128415734, 7281038983527843915, 7281400873163414034, 7276210070179232713, 7276210070179231513, 7276210070179232444, 7277329574879397970, 7278438518255214039, 7276210070179232568, 7276584518312632670, 7276210070179232532, 7278981127241465971, 7277329574879397882, 7281400873163413871, 7277582707364736626, 7280731395169676416, 7281787965681367223, 7274076137150484748, 7275972790413469433, 7277042241565137639, 7277582707364736590, 7274442089838939437, 7281539080913949796, 7274813162128415660, 7281400873163414101, 7276300075511353717, 7276671156390725674, 7279266197105809149, 7277042241565100712, 7276300075511353630, 7281539080913949798, 7276300075511353435, 7274076137150519066, 7276210070183066504, 7277329574882842331, 7276210070183098030, 7275972790413503589, 7277329574882865678, 7278524009577235388, 7282184958101794405, 7275541915003032899, 7281787965685326215, 7276210070183098139, 7275972790413503587, 7275541915004709803, 7275972790413503445, 7279548226140050292, 7281400873170677259, 7276300075511389466, 7276210070183098155, 7276300075511389447, 7276300075511389469, 7281400873173166475, 7277449417349722458, 7282549115528318627, 7281400873172405001, 7275972790413460216, 7276584518316324695, 7277449417349722491, 7279922176059811063, 7281400873166734634, 7276300075511389456, 7275972790413469878, 7275972790413469884, 7279185241269910524, 7281400873168426655, 7275972790413469888, 7279548226135910332, 7276210070179234645, 7281038983513933232, 7281787965681369489, 7277042241565137953, 7282549115530344509, 7276210070179235268, 7276210070179235199, 7279185241269910400, 7276210070179235561, 7276032864120995843, 7282985299481728410, 7277582707364736656, 7276300075511354057, 7281400873163415583, 7275099640755721041, 7276300075511354051, 7276300075511353977, 7282910390964322179, 7276300075511354067, 7277042241565137945, 7282910390979080425, 7281400873168426718, 7276300075511354061, 7276300075511354010, 7277329574883044574, 7276210070183295642, 7281400873170719425, 7276210070183295751, 7280731395168084886, 7279185241274445891, 7282910390962588765, 7275972790413505399, 7279548226140260942, 7282237451186239826, 7276210070183295821, 7278438518258762297, 7281400873170719524, 7281400873166894748, 7282910390962715103, 7275972790413505429, 7281400873173362379, 7278808924829734060, 7276210070183295843, 7277817762345747259, 7276300075511391771, 7275972790413505392, 7276210070183294902, 7275541915003108575, 7276210070183295489, 7278438518266252728, 7282608519180769444, 7276210070183295855, 7282910390975432542, 7274076137150521559, 7275972790413469778, 7276391042918645762, 7275972790413469785, 7276210070179234133, 7276210070179234449, 7276210070179233683, 7276210070179233876, 7276210070179234200, 7274076137150485397, 7276210070179234119, 7281400873169971699, 7275836670017580828, 7276210070179234135, 7281400873172840988, 7275972790413469762, 7274442089838940074, 7282910390959288502, 7282237451186224493, 7277042241565137932, 7280295627754719915, 7276300075511353913, 7276584518312633087, 7277582707364736637, 7281400873168426441, 7282237451186224500, 7281124199958062112, 7276210070179234797, 7276300075511354082, 7281517236713270811, 7281400873169167362, 7278895382515179458, 7274909317856241142, 7276210070179246646, 7274442089838941928, 7274909317856241149, 7277449417349687220, 7276584518312647100, 7275972790413471217, 7282549115513390816, 7276210070179245978, 7279266197105811170, 7276210070179246060, 7276210070179246602, 7276955633552275959, 7275972790413471394, 7274076137150487154, 7274076137150487107, 7276671156390756071, 7274813162128417566, 7281124199958063564, 7282549115530344704, 7281124199958063549, 7275099640745059924, 7275186841463040205, 7274813162128418130, 7279637256510378767, 7275186841463040192, 7276671156390755736, 7282985299481729940, 7276671156390755751, 7280105347816105092, 7276210070179247696, 7280731395136090285, 7277582707364737146, 7275099640745061833, 7281400873168430056, 7279185241283620423, 7278981127241465982, 7274442089838943033, 7277329574891654392, 7278438518259354004, 7281400873171115039, 7275972790413471814, 7277582707364737115, 7275972790413471846, 7276391042918645791, 7274076137150488578, 7282985299481731062, 7282608519180733738, 7274076137150488162, 7275972790413471724, 7281124199958064288, 7275099640745061785, 7275581089396039009, 7274076137150488199, 7276210070179249869, 7277582707364737119, 7274076137150487857, 7275972790413472093, 7274813162128418524, 7275541915005354300, 7276584518324166847, 7282549115492448288, 7282184958121285134, 7281038983524798242, 7274359471861443841, 7281038983524798245, 7282549115503132087, 7278438518259355092, 7279266197105847383, 7276210070183317094, 7274909317856252550, 7274750472801172319, 7274813162128454462, 7275972790413470128, 7281539080913988720, 7274076137150488606, 7276300075511392054, 7281400873163414096, 7281787965694018192, 7274442089838940385, 7275972790413472110, 7275581089396078951, 7281787965694018260, 7281787965694018321, 7282608519180730646, 7277329574886688757, 7274813162128456131, 7282985299481763571, 7276300075511319671, 7278068274897959364, 7282910390971814045, 7282184958109864710, 7282989031808334674, 7280295627760166380, 7281038983525301345, 7282549115506187691, 7278068274897645886, 7278808924831058476, 7283268402266496274, 7277329574882810762, 7276584518316288432, 7281787965685239324, 7277329574882808900, 7279185241275750403, 7275972790413503386, 7280295627758662514, 7280379448334005196, 7281539080913986066, 7281539080913988547, 7275581089396068836, 7274076137150518844, 7281038983517161221, 7274813162128451263, 7276300075511389408, 7274076137150518842, 7276955633556444945, 7281038983517161210, 7283268402257867716, 7278168390580091087, 7279610520360351236, 7276231691056947559, 7282595681535583749, 7281866838479573567, 7281136505081011523, 7282240195690010935, 7281866838479573586, 7277417892319944317, 7278104404171554766, 7276231691056947588, 7275199369908235808, 7275199369908277670, 7275199369931970793, 7275199369908244023, 7278850461478217073, 7277789449927752149, 7282968398806560578, 7275199369921031352, 7275858342436423597, 7275858342435685162, 7276603459131031035, 7280382691058766546, 7277417892319913318, 7281866838468767074, 7279968862367307292, 7278850461462647230, 7275858342435683572, 7279610520360217151, 7276993880257773158, 7282968398827743543, 7282968398803541661, 7282968398803541611, 7279220335453971090, 7275199369903641866, 7279968862372730626, 7280382691051638648, 7277789449938051142, 7276603459127897703, 7279968862355006994, 7280382691064247177, 7276231691065425844, 7275199369903642223, 7276993880242898725, 7277417892311335500, 7276993880242898742, 7281136505075151266, 7275199369907672045, 7279968862357836706, 7274442905909837844, 7275858342435651630, 7275199369907678381, 7275858342435651403, 7275858342436368413, 7282968398806546368, 7277789449927753659, 7279610520349359213, 7275514732167658488, 7282968398806546387, 7278477619660821150, 7281495057517082272, 7282240195680227559, 7277789449945638770, 7277789449916414986, 7280382691039757982, 7279968862358500457, 7274442905909903458, 7275199369908196376, 7278850461463239497, 7280382691039757671, 7276231691057148240, 7275199369908491164, 7275514732159518714, 7275199369908196403, 7275514732173225393, 7279220335457197139, 7275858342435614231, 7275199369931402402, 7281136505070165030, 7278850461462617458, 7282595681551124686, 7275199369907586513, 7278104404171090595, 7275199369907594668, 7282595681535157505, 7275858342435611857, 7281136505046439510, 7275514732173063032, 7279220335456521778, 7279968862372877988, 7278850461462612451, 7282240195680227558, 7282968398818786662, 7281136505075302739, 7282595681541727548, 7276231691046793342, 7279610520350789407, 7277417892300246164, 7282968398826609023, 7279968862369838439, 7275199369908196323, 7281136505090026800, 7281866838479570144, 7275199369907665058, 7277789449945636088, 7281495057517625447, 7277789449945639256, 7279610520351097126, 7275199369908575993, 7280382691052650098, 7281495057518011514, 7279968862358587748, 7282968398807343418, 7282968398807325592, 7278850461477700676, 7282968398807343383, 7276993880246433723, 7281495057525619158, 7282595681544710326, 7278477619647324426, 7282240195703746325, 7279610520351222591, 7278850461477704913, 7277789449943428331, 7278104404171691324, 7282240195680557336, 7282968398826659545, 7276603459131883850, 7275858342436353338, 7278850461463423277, 7279968862358480456, 7275514732159625546, 7282240195680557356, 7282968398826686064, 7276231691057364773, 7275199369908734389, 7277789449945640069, 7282968398807493530, 7277417892299894938, 7282968398790497988, 7280382691039836785, 7282968398826689704, 7281136505087149713, 7282968398807262256, 7276603459131914610, 7277789449939137176, 7281136505075139852, 7279220335470293997, 7277789449934053818, 7274442905905014818, 7275199369908767442, 7274442905897169074, 7275199369930002791, 7275199369906002633, 7282595681534258230, 7282968398789755990, 7276603459129723956, 7275514732166963198, 7276231691055124330, 7282968398805345724, 7276993880255614419, 7281136505053214792, 7275858342434250633, 7275199369930008211, 7277789449945620774, 7274442905897166234, 7282237451186238275, 7276210070179514068, 7274076137150492700, 7276300075511359537, 7279022985992742945, 7274442089838947257, 7276210070179513863, 7276210070179513896, 7275099640745380120, 7278808924825605168, 7280379448333975364, 7276210070179492727, 7276210070179514970, 7274909317856242057, 7276300075511359565, 7278524009577207789, 7277042241565144642, 7275972790413477128, 7276300075511360690, 7281866353126952655, 7276391042918645870, 7281866353126952662, 7274076137150492306, 7274909317856242217, 7281787965691974784, 7281539080913958652, 7276300075511360790, 7278524009577207792, 7282985299481736950, 7277744825200686541, 7283268402265842950, 7276210070178087203, 7278438518254291053, 7277329574878397978, 7276584518311594861, 7277329574878397894, 7275099640743776542, 7275541915001367570, 7282184958113726000, 7283268402252516855, 7281787965680135781, 7275099640743776411, 7276584518311595151, 7276584518311595154, 7276210070186531422, 7276300075511360838, 7278438518255442873, 7276300075511360794, 7276300075511360639, 7274076137150492269, 7275541915004176940, 7275541914999857108, 7274813162128422552, 7276955633552566420, 7279548226136166375, 7276210070179450150, 7276300075511322517, 7280379448333976405, 7278438518255442874, 7276300075511360645, 7278524009577207265, 7277042241565144039, 7274076137150491547, 7277582707364738693, 7274076137150493228, 7276300075511360242, 7275972790413476573, 7275972790413476458, 7281866353126952165, 7277582707364738691, 7281866353126952167, 7276210070188844490, 7276300075511359827, 7276210070189519242, 7276300075511360352, 7275972790413506427, 7281866353126984652, 7282608519180770637, 7274909317856252342, 7274442089838978024, 7276300075511393128, 7282237451186271393, 7276300075511393158, 7275972790413506423, 7283268402266021186, 7280731395156219452, 7277582707364752454, 7274909317856252988, 7275186841463075591, 7277042241565176444, 7277042241565143792, 7274813162128421758, 7277042241565146465, 7278438518255429441, 7275972790413476219, 7278438518267079514, 7282910390977822658, 7276300075511359804, 7276300075511359898, 7276300075511359797, 7274750472788870383, 7279266197105816187, 7281400873163607781, 7276210070179498915, 7281400873168467325, 7274813162128453608, 7281400873170705147, 7277744825201461724, 7277744825201461727, 7280379448333963703, 7280008354569707506, 7274909317856252267, 7274076137150522382, 7281787965692571179, 7276300075511391388, 7278168390580045772, 7279185241274355294, 7274442089838976244, 7274750472799754039, 7276210070183216290, 7274813162128452573, 7276300075511392375, 7277582707364751715, 7277582707364752624, 7277042241565175778, 7276300075511390544, 7276300075511389673, 7275972790413504415, 7277449417349725180, 7276300075511390548, 7276300075511392404, 7277042241565128603, 7277449417349725182, 7280295627754959616, 7280295627758964659, 7276210070179519720, 7278524009577209373, 7275186841463030616, 7276300075511362258, 7276300075511362389, 7282985299481737004, 7274909317856252676, 7274442089838948471, 7275972790413478130, 7274076137150493787, 7276300075511362035, 7274076137150493555, 7280786619823567162, 7276300075511362380, 7276300075511362366, 7276210070179511758, 7275099640745395134, 7276210070179511608, 7274076137150492554, 7278524009577207973, 7275972790413477254, 7274750472788884019, 7276300075511361023, 7276210070179511591, 7279548226136170655, 7278524009577207959, 7274442089838947193, 7276210070179511549, 7275541914999858560, 7275099640745396001, 7278104404175951659, 7274442905914157757, 7275199369937026895, 7278477619651241571, 7281495057523167450, 7281495057523167448, 7278104404175951703, 7279220335461080147, 7279968862362659437, 7275199369914193153, 7282595681556125229, 7282968398811300581, 7281136505068771367, 7275199369940116664, 7275514732177493338, 7275858342441403789, 7282595681539226862, 7279968862362662830, 7275199369902889638, 7281866838465908232, 7278104404182583048, 7281495057523149379, 7276603459136173304, 7275199369940116621, 7281136505091903344, 7282968398827267411, 7277417892315214804, 7274442905906349849, 7275858342441402148, 7281136505082399824, 7277789449945155807, 7277789449945690384, 7275199369902889490, 7281136505088061842, 7278104404175951449, 7275199369940035922, 7279220335461081208, 7279610520361609846, 7278104404175959406, 7278477619658951023, 7278477619658951422, 7277789449934553357, 7281136505082399498, 7276231691061788403, 7281495057523154084, 7279968862373065567, 7276993880257494155, 7276993880255856603, 7278104404175961213, 7281136505088062300, 7277789449945155748, 7278104404175951550, 7281495057523165583, 7281866838472850078, 7282240195704520391, 7282240195704520423, 7278850461466959423, 7282968398811308986, 7278104404182583045, 7282595681552275969, 7279610520354895637, 7276603459136172962, 7278477619651237626, 7274442905906349486, 7281136505076770356, 7278850461466944613, 7278104404167579210, 7281866838472841822, 7277417892304276235, 7281136505048784108, 7277789449931741501, 7275514732172207949, 7281866838482464444, 7276603459136177235, 7274442905906349880, 7276993880250549321, 7275858342431578369, 7279610520354896088, 7279610520354900271, 7278477619651241483, 7282240195691628310, 7275514732174242897, 7275199369937031105, 7276603459136180672, 7282240195691627335, 7282240195698258925, 7282595681539227343, 7275199369937031185, 7282595681539227336, 7281866838472844386, 7276231691061789770, 7275858342431577592, 7277789449931741545, 7275858342441395106, 7280382691049250429, 7282968398811293392, 7276603459136172813, 7276231691061789739, 7277417892304276070, 7280382691049250692, 7281539080913954149, 7274442089838943791, 7276300075511357701, 7274442089838943781, 7274076137150528234, 7276300075511357700, 7279637256510418689, 7282608519180734341, 7279266197105813073, 7276300075511357651, 7282184958098227347, 7275099640745065012, 7275541915004769342, 7276584518312654780, 7276210070179252757, 7281038983513949807, 7278068274894373589, 7276584518312653853, 7282184958106390587, 7281517236710764977, 7282910390964324000, 7280731395142943480, 7279548226135926519, 7275541915001756742, 7282549115501218162, 7275099640745065926, 7275541915001756786, 7279185241269928384, 7276584518312652848, 7282910390959304729, 7274813162128419414, 7276300075511357286, 7274076137150488771, 7278895382515180826, 7275581089396039207, 7275581089396039202, 7278808924825365370, 7280379448333972144, 7275186841463041396, 7276300075511319778, 7276391042918645800, 7276300075511357438, 7276300075511357443, 7276300075511319805, 7276300075511357437, 7280379448333972271, 7281539080913953972, 7280008354569672680, 7282237451186235412, 7276300075511357463, 7282184958103019240, 7279548226135928396, 7278438518255237540, 7276955633552284160, 7276210070179252751, 7276955633552284062, 7280731395142947260, 7278068274894375601, 7278438518255237522, 7275099640745066087, 7278168390580058366, 7275186841463041642, 7278895382515181071, 7279637256510380789, 7277042241565101449, 7277042241565141152, 7275186841463041683, 7278524009577203592, 7278524009577203596, 7278524009577238025, 7279548226135927806, 7279548226135927286, 7275099640751086625, 7278808924825367725, 7281787965681387764, 7279185241269929538, 7281787965687239636, 7282549115490905206, 7276210070179251831, 7278808924825364005, 7281866353126933683, 7276300075511357364, 7283268402253831876, 7282989031808315336, 7276300075511357339, 7281866353126948521, 7276300075511357363, 7274442089838943563, 7281866353126948443, 7276300075511357418, 7275972790413472730, 7274750472788603397, 7276300075511400309, 7275186841463030180, 7276210070179252799, 7274076137150489218, 7280008354569672906, 7276300075511400297, 7276300075511357737, 7276300075511357720]
                    return JsonResponse({'code': 200, "uuid2": uuid2})
                except:
                    return JsonResponse({'code': 500, "uuid2": "uuid查询异常"})
            else:
                return JsonResponse({'code': 443,"error":"start_date与end_date不能为空"})
        else:
            return JsonResponse({'code': 429, "error": "用户名或密码错误"})
    else:
        return JsonResponse({'code': 403,"error":"当前服务器拒绝GET方式请求，请使用POST方式"})

@csrf_exempt
def sop_lv_name(request):
    if request.method == 'POST':
        if (request.META.get('HTTP_NAME') == "nint") and (request.META.get('HTTP_PASSWORD') == "chen.weihong"):
            data = json.loads(request.body)
            print(data)
            if (data.get('start_date')!=None) and (data.get('end_date')!=None) and (data.get('eid')!=None) and (data.get('table')!=None):
                try:
                    start_date = data.get('start_date')
                    end_date = data.get('end_date')
                    eid = data.get('eid')
                    table = data.get('table')
                    cid = data.get('cid', [])
                    # print(cid)
                    df_lvname = lv_name.run(starttime=start_date,endtime=end_date,eid=eid,table=table,cid=cid).to_dict()

                        # print(df_lvname)
                    return JsonResponse({'code': 200, "data": df_lvname})
                except:
                    return JsonResponse({'code': 500, "data": "df_lvname查询异常"})
            else:
                return JsonResponse({'code': 443,"error":"无效的JSON数据"})
        else:
            return JsonResponse({'code': 429, "error": "用户名或密码错误"})
    else:
        return JsonResponse({'code': 403,"error":"当前服务器拒绝GET方式请求，请使用POST方式"})